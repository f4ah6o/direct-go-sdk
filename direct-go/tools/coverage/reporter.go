package main

import (
	"encoding/json"
	"fmt"
	"strings"
)

// GenerateJSON outputs the coverage report as formatted JSON
func GenerateJSON(report *CoverageReport) ([]byte, error) {
	return json.MarshalIndent(report, "", "  ")
}

// GenerateMarkdown outputs the coverage report as Markdown
func GenerateMarkdown(report *CoverageReport) string {
	var sb strings.Builder

	// Header
	sb.WriteString("# Direct4B Porting Coverage Report\n\n")
	sb.WriteString(fmt.Sprintf("**Generated**: %s\n\n", report.Metadata.GeneratedAt.Format("2006-01-02 15:04:05")))

	// Summary
	sb.WriteString("## Summary\n\n")
	sb.WriteString(fmt.Sprintf("- **JavaScript Methods**: %d\n", report.Summary.TotalJSMethods))
	sb.WriteString(fmt.Sprintf("- **Go Methods**: %d\n", report.Summary.TotalGoMethods))
	sb.WriteString(fmt.Sprintf("- **Coverage**: %.2f%% (%d/%d)\n",
		report.Summary.CoveragePercent,
		report.Summary.ImplementedCount,
		report.Summary.TotalJSMethods))
	sb.WriteString(fmt.Sprintf("- **Missing**: %d methods\n\n", report.Summary.MissingCount))

	// Coverage by Category
	sb.WriteString("## Coverage by Category\n\n")
	sb.WriteString("| Category | Total | Implemented | Coverage | Status |\n")
	sb.WriteString("|----------|-------|-------------|----------|--------|\n")

	for _, category := range report.Categories {
		status := GetCoverageStatus(category.CoveragePercent)
		sb.WriteString(fmt.Sprintf("| %s | %d | %d | %.1f%% | %s |\n",
			category.Name,
			category.TotalMethods,
			category.ImplementedCount,
			category.CoveragePercent,
			status))
	}
	sb.WriteString("\n")

	// Detailed Status
	sb.WriteString("## Detailed Status\n\n")

	for i, category := range report.Categories {
		sb.WriteString(fmt.Sprintf("### %d. %s (%.1f%%)\n\n", i+1, category.Name, category.CoveragePercent))

		// Implemented methods
		if len(category.Implemented) > 0 {
			sb.WriteString(fmt.Sprintf("#### ‚úÖ Implemented (%d)\n", len(category.Implemented)))
			for _, method := range category.Implemented {
				sb.WriteString(fmt.Sprintf("- `%s`\n", method))
			}
			sb.WriteString("\n")
		}

		// Missing methods
		if len(category.Missing) > 0 {
			sb.WriteString(fmt.Sprintf("#### ‚ùå Missing (%d)\n", len(category.Missing)))
			for _, method := range category.Missing {
				sb.WriteString(fmt.Sprintf("- `%s`\n", method))
			}
			sb.WriteString("\n")
		}
	}

	// Priority Recommendations
	sb.WriteString("## Priority Recommendations\n\n")
	sb.WriteString("Based on common usage patterns, consider implementing:\n\n")

	sb.WriteString("### üî¥ High Priority (Core functionality)\n")
	highPriority := []string{
		"get_messages - Retrieve messages from a talk",
		"get_users - Get user information",
		"update_read_statuses - Mark messages as read (not in current list)",
		"create_group_talk - Create group conversations",
		"create_pair_talk - Create 1-to-1 conversations",
	}
	for _, item := range highPriority {
		sb.WriteString(fmt.Sprintf("- %s\n", item))
	}
	sb.WriteString("\n")

	sb.WriteString("### üü° Medium Priority (Enhanced functionality)\n")
	mediumPriority := []string{
		"search_messages - Search through message history",
		"get_attachments - Retrieve file attachments",
		"add_favorite_message - Bookmark messages",
		"get_profile - Get detailed user profiles",
		"update_group_talk - Modify group settings",
	}
	for _, item := range mediumPriority {
		sb.WriteString(fmt.Sprintf("- %s\n", item))
	}
	sb.WriteString("\n")

	sb.WriteString("### üü¢ Low Priority (Advanced features)\n")
	lowPriority := []string{
		"Conference/call methods - Video/audio calls",
		"Note management - Collaborative notes",
		"Announcement system - Broadcast messages",
		"Scheduled messages - Send messages at specific times",
	}
	for _, item := range lowPriority {
		sb.WriteString(fmt.Sprintf("- %s\n", item))
	}
	sb.WriteString("\n")

	// Footer
	sb.WriteString("---\n")
	sb.WriteString(fmt.Sprintf("*Generated by direct4b-coverage-tool v%s*\n", report.Metadata.ToolVersion))

	return sb.String()
}

// GenerateTextSummary outputs a brief text summary for console output
func GenerateTextSummary(report *CoverageReport) string {
	var sb strings.Builder

	sb.WriteString(fmt.Sprintf("Direct4B Porting Coverage: %.2f%% (%d/%d methods)\n",
		report.Summary.CoveragePercent,
		report.Summary.ImplementedCount,
		report.Summary.TotalJSMethods))

	sb.WriteString("\nTop 3 Categories by Coverage:\n")

	// Sort categories by coverage percentage (descending)
	type categoryWithCoverage struct {
		name     string
		coverage float64
	}
	var sorted []categoryWithCoverage
	for _, cat := range report.Categories {
		sorted = append(sorted, categoryWithCoverage{cat.Name, cat.CoveragePercent})
	}

	// Simple bubble sort for top 3
	for i := 0; i < len(sorted); i++ {
		for j := i + 1; j < len(sorted); j++ {
			if sorted[j].coverage > sorted[i].coverage {
				sorted[i], sorted[j] = sorted[j], sorted[i]
			}
		}
	}

	for i := 0; i < 3 && i < len(sorted); i++ {
		status := GetCoverageStatus(sorted[i].coverage)
		sb.WriteString(fmt.Sprintf("  %s %s: %.1f%%\n", status, sorted[i].name, sorted[i].coverage))
	}

	return sb.String()
}
